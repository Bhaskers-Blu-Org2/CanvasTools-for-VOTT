<!doctype html>
<html>

<head>
    <link rel="stylesheet" href="css/index.css" />
    <title>CanvasTools Samples - Palatte Editor</title>
</head>

<body>
    <h1>CanvasTools Samples - Palatte Editor</h1>
    <div id="canvasToolsDiv">
        <div id="toolbarDiv">
        </div>
        <div id="selectionDiv">
            <div id="editorDiv"></div>
        </div>
    </div>

    <div id="controls">
        <div>
            <label for="imageSelect" >Choose image: </label>
            <select id="imageSelect">
            </select>
        </div>
    </div>
</body>
<script src="./../shared/js/ct.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", (e) => {
        let ct = CanvasTools;
        let sz = document.getElementById("editorDiv");
        let tz = document.getElementById("toolbarDiv");

        let editor = new ct.Editor(sz).api;
        editor.addToolbar(tz, ct.Editor.FullToolbarSet, "./../shared/media/icons/");

        let incrementalRegionID = 100;

        editor.onSelectionEnd = (regionData) => {
            let id = (incrementalRegionID++).toString();
            let tags = generateTagDescriptor();            
            editor.addRegion(id, regionData, tags);
        };        

        editor.freeze();
        editor.disable();
        
        let paletteSettings = {
                lightness: 0.7,
                lightnessVariation: 0.1,
                minGrayness: 0.2,
                maxGrayness: 0.6,
                granularity: 50,
                abRange: 1.3,
            };
        let palette = new CanvasTools.Core.Colors.Palette(paletteSettings);

        let tags = [];
        let tagNames = ["Awesome", "Amazing", "Brilliante", "Incredible", "Marvelous",
                        "Unbelievable", "Wonderful", "Shocking", "Surprising", "Startling"];

        palette.swatches(tagNames.length).then((gamut) => {
            gamut.forEach((color, index) => {
                tags.push(new ct.Core.Tag(tagNames[index], color));
            });
            // when swatches are ready enable the editor
            editor.unfreeze();
            editor.enable();
        });

        function generateTagDescriptor() {
            let rnd = (n) => {
                let r = Math.floor(Math.random() * n);
                if (r === n) {
                    r = n - 1;
                }
                return r;
            };

            const n = tags.length;
            return new ct.Core.TagsDescriptor(tags[rnd(n)], [tags[rnd(n)], tags[rnd(n)]]);
        };
        
        editor.onRegionMoveBegin = (id, regionData) => {
            console.log(`Move Begin ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };

        editor.onRegionMove = (id, regionData) => {
            console.log(`Moving ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };

        editor.onRegionMoveEnd = (id, regionData) => {
            console.log(`Move End ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };

        // Init image selector
        let images = [
            {
                path: "./../shared/media/background-cat-hd.jpg",
                title: "Cat (HD)"
            },
            {
                path: "./../shared/media/background-cat2.jpg",
                title: "Cat - Grumpy"
            },
            {
                path: "./../shared/media/background-cat3.jpg",
                title: "Cat - Inspiring"
            },                                   
            {
                path: "./../shared/media/background-city.jpg",
                title: "City"
            },
            {
                path: "./../shared/media/background-forest-hd.jpg",
                title: "Forest (HD)"
            },
            {
                path: "./../shared/media/background-glass.jpg",
                title: "Cafe"
            },
            {
                path: "./../shared/media/background-sea-hd.jpg",
                title: "Sea (HD)"
            },
            {
                path: "./../shared/media/background-snow.jpg",
                title: "Snow"
            }, 
        ];

        function loadImage(path) {
            let image = new Image();
            image.addEventListener("load", (e) => {
                editor.addContentSource(e.target);
            });
            image.src = path;
        }

        let imageIndex = 0;
        initImageSelect(images, (index, path) => {
            imageIndex = index;
            loadImage(path);
        });
        loadImage(images[imageIndex].path);
    });

    function initImageSelect(images, onSelect) {
        var imageSelect = document.getElementById("imageSelect");

        images.forEach((image) => {
            let o = document.createElement("option");
            o.text = image.title;
            imageSelect.add(o);
        })
        imageSelect.selectedIndex = 0;

        imageSelect.addEventListener("change", (e) => {
            let index = imageSelect.selectedIndex;
            if (index >= 0 && index < images.length) {
                onSelect(index, images[index].path);
            }
        });
    }
</script>

</html>