<!doctype html>
<html>

<head>
    <link rel="stylesheet" href="css/index.css" />
    <title>CanvasTools Samples - Palatte in the Editor</title>
</head>

<body>
    <h1>CanvasTools Samples - Palatte in the Editor</h1>
    <div id="canvasToolsDiv">
        <div id="toolbarDiv">
        </div>
        <div id="selectionDiv">
            <div id="editorDiv"></div>
        </div>
    </div>

    <div id="tags"></div>
</body>
<script src="./../shared/js/ct.js"></script>
<script>
    // Init image selector
    let images = [
            {
                path: "./../shared/media/background-cat-hd.jpg",
                title: "Cat (HD)"
            },
            {
                path: "./../shared/media/background-cat2.jpg",
                title: "Cat - Grumpy"
            },
            {
                path: "./../shared/media/background-cat3.jpg",
                title: "Cat - Inspiring"
            },                                   
            {
                path: "./../shared/media/background-city.jpg",
                title: "City"
            },
            {
                path: "./../shared/media/background-forest-hd.jpg",
                title: "Forest (HD)"
            },
            {
                path: "./../shared/media/background-glass.jpg",
                title: "Cafe"
            },
            {
                path: "./../shared/media/background-sea-hd.jpg",
                title: "Sea (HD)"
            },
            {
                path: "./../shared/media/background-snow.jpg",
                title: "Snow"
            }, 
        ];

    let tagNames = ["Awesome", "Amazing", "Brilliante", "Incredible", "Marvelous",
                    "Unbelievable", "Wonderful", "Shocking", "Surprising", "Startling"];

    document.addEventListener("DOMContentLoaded", (e) => {
        let sz = document.getElementById("editorDiv");
        let tz = document.getElementById("toolbarDiv");

        let editor = new CanvasTools.Editor(sz).api;
        editor.addToolbar(tz, CanvasTools.Editor.FullToolbarSet, "./../shared/media/icons/");

        let incrementalRegionID = 100;

        editor.onSelectionEnd = (regionData) => {
            let id = (incrementalRegionID++).toString();
            let tags = new CanvasTools.Core.TagsDescriptor(getActiveTag());            
            editor.addRegion(id, regionData, tags);
        };        

        editor.onRegionMoveBegin = (id, regionData) => {
            console.log(`Move Begin ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };

        editor.onRegionMove = (id, regionData) => {
            console.log(`Moving ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };

        editor.onRegionMoveEnd = (id, regionData) => {
            console.log(`Move End ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };

        editor.freeze();
        editor.disable();
        
        const paletteSettings = {
            lightness: 0.5,
            lightnessVariation: 0.1,
            minGrayness: 0.1,
            maxGrayness: 2.0,
            granularity: 100,
            abRange: 1.3,
        };

        const palette = new CanvasTools.Core.Colors.Palette(paletteSettings);

        const swatchesCount = tagNames.length;

        palette.swatches(swatchesCount).then((gamut) => {
            const tags = gamut.map((color, index) => {
                return new CanvasTools.Core.Tag(tagNames[index], color);
            });

            populateTags(tags);
            // when swatches are ready enable the editor
            editor.unfreeze();
            editor.enable();
        });

        let imageIndex = 1;
        loadImage(images[imageIndex].path, (image) => {
            editor.addContentSource(image);
        });
    });

    let activeTag;

    function populateTags(tags) {
        let container = document.getElementById("tags");

        tags.forEach((tag) => {
            const tagButton = document.createElement("button");
            tagButton.classList.add("tagButton");

            tagButton.innerHTML = tag.name;
            tagButton.style.backgroundColor = tag.color;
            
            tagButton.addEventListener("click", (e) => {
                container.querySelectorAll("button").forEach((button) => button.classList.remove("active"));
                tagButton.classList.add("active");
                activeTag = tag;
            });

            container.append(tagButton);
        });

        // set the first tag active
        container.querySelector("button").classList.add("active");
        activeTag = tags[0];
    }

    function getActiveTag() {
        return activeTag;
    }

    function loadImage(path, onready) {
        const image = new Image();
        image.addEventListener("load", (e) => {
            onready(e.target);                
        });
        image.src = path;
    }
</script>

</html>