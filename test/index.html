<!doctype html>
<html>

<head>
    <link rel="stylesheet" href="css/index.css" />
    <title>CanvasTools Demo</title>
</head>

<body>
    <div id="ctZone">
        <div id="toolbarzone">
            <svg id="toolbarSVG">
                <defs>
                    <filter id="black-glow">
                        <feGaussianBlur in="SourceAlpha" stdDeviation="2" />
                        <feOffset dx="0" dy="0" result="offsetblur" />
                        <feComponentTransfer>
                            <feFuncA type="linear" slope="0.8" />
                        </feComponentTransfer>
                        <feMerge>
                            <feMergeNode />
                            <feMergeNode in="SourceGraphic" />
                        </feMerge>
                    </filter>
                </defs>
            </svg>
        </div>
        <div id="selectionzone">
            <svg id="selectionSVG">
                <defs>
                    <filter id="black-glow">
                        <feGaussianBlur in="SourceAlpha" stdDeviation="2" />
                        <feOffset dx="0" dy="0" result="offsetblur" />
                        <feComponentTransfer>
                            <feFuncA type="linear" slope="0.8" />
                        </feComponentTransfer>
                        <feMerge>
                            <feMergeNode />
                            <feMergeNode in="SourceGraphic" />
                        </feMerge>
                    </filter>
                </defs>
            </svg>
            <canvas id="sourceImageCnvs"></canvas>
        </div>
    </div>

    <div>Some text <input type="text" /></div>
</body>
<script src="./js/ct.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", (e) => {
        var ct = CanvasTools.CanvasTools;
        var sz = document.getElementById("selectionSVG");
        var tz = document.getElementById("toolbarSVG");
        var regionId = 100;

        // create regions manager 
        let rm = new ct.Region.RegionsManager(sz, () => { }, () => { });
        // create area selector manager 
        let rmWasFrozen = false;
        let selector = new ct.Selection.AreaSelector(sz,
            {
                onSelectionBegin: () => {
                    //console.log("Rock the party!");
                    rmWasFrozen = rm.isFrozen;
                    rm.freeze();
                },
                onSelectionEnd: (commit) => {
                    if (!rmWasFrozen) {
                        rm.unfreeze();
                    }
                    
                    let r = commit.boundRect;
                    console.log("Selection: " + JSON.stringify(commit));
                    var primaryTag = new ct.Base.Tags.Tag(
                        (Math.random() > 0.5) ? "Awesome" : "Brilliante!",
                        Math.floor(Math.random() * 360.0));
                    var secondaryTag = new ct.Base.Tags.Tag(
                        (Math.random() > 0.5) ? "Yes" : "No",
                        Math.floor(Math.random() * 360.0));
                    var ternaryTag = new ct.Base.Tags.Tag(
                        (Math.random() > 0.5) ? "one" : "two",
                        Math.floor(Math.random() * 360.0));
                    var tags = new ct.Base.Tags.TagsDescriptor(primaryTag, [secondaryTag, ternaryTag]);

                    if (commit.meta !== undefined && commit.meta.point !== undefined) {
                        let point = commit.meta.point;
                        rm.addPointRegion((regionId++).toString(), { x: point.x, y: point.y }, tags);
                    } else {
                        rm.addRectRegion((regionId++).toString(), { x: r.x1, y: r.y1 }, { x: r.x2, y: r.y2 }, tags);
                    }
                    
                }
            }
            
        );

        rm.onManipulationEnd = () => {
            selector.show();
        };
        rm.onManipulationBegin = () => {
            selector.hide();
        };

        // create toolbar
        let toolbar = new ct.Toolbar.Toolbar(tz);
        

        let noneIcon = {
            action: "none-select",
            iconUrl: "./images/icons/none-selection.svg",
            tooltip: "Regions Manipulation (M)",
            keycode: 'KeyM'
        }
            
        toolbar.addSelector(noneIcon, (action) => {
            selector.setSelectionMode(ct.Selection.SelectionMode.NONE);
        });

        toolbar.addSeparator();

        let pointIcon = {
            action: "point-select",
            iconUrl: "./images/icons/point-selection.svg",
            tooltip: "Point-selection (P)",
            keycode: 'KeyP'
        }
            
        toolbar.addSelector(pointIcon, (action) => {
            selector.setSelectionMode(ct.Selection.SelectionMode.POINT);
        });

        let rectIcon = {
            action: "rect-select",
            iconUrl: "./images/icons/rect-selection.svg",
            tooltip: "Rectangular box (R)",
            keycode: 'KeyR'
        };

        toolbar.addSelector(rectIcon, (action) => {
            selector.setSelectionMode(ct.Selection.SelectionMode.RECT);
        });        
        
        let copyTemplateIcon = {
            action: "copy-select",
            iconUrl: "./images/icons/copy-t-selection.svg",
            tooltip: "Template-based box (T)",
            keycode: 'KeyT'
        };
        
        toolbar.addSelector(copyTemplateIcon, (action) => {
            let rs = rm.getSelectedRegionsBounds();
            if (rs !== undefined && rs.length > 0) {
                let r = rs[0];
                selector.setSelectionMode(ct.Selection.SelectionMode.COPYRECT, { template: new ct.Base.Rect.Rect(r.width, r.height) });
            } else {
                selector.setSelectionMode(ct.Selection.SelectionMode.COPYRECT, { template: new ct.Base.Rect.Rect(40, 50) });
            }
        });

        let polylineIcon = {
            action: "polyline-select",
            iconUrl: "./images/icons/polyline-selection.svg",
            tooltip: "Polyline-selection (Y)",
            keycode: 'KeyY'
        };
        
        toolbar.addSelector(polylineIcon, (action) => {
            selector.setSelectionMode(ct.Selection.SelectionMode.POLYLINE);
        });

        toolbar.addSeparator();

        let selectionLockIcon = {
            action: "selection-lock",
            iconUrl: "./images/icons/selection-lock.svg",
            tooltip: "Lock/unlock regions (L)",
            keycode: 'KeyL',
        };

        toolbar.addSwitch(selectionLockIcon, (action) => {
            regionsManager.toggleFreezeMode();
        });  

        toolbar.setSwitch("selection-lock", false);
        toolbar.select("rect-select");

        // Upload background image for selection 
        let imageCnvs = document.getElementById("sourceImageCnvs");
        let imagePath = "./../images/background-cat.jpg";
        let image = new Image();
        image.addEventListener("load", (e) => {
            // Create buffer
            let buffCnvs = document.createElement("canvas");
            let context = buffCnvs.getContext("2d");
            buffCnvs.width = e.target.width;
            buffCnvs.height = e.target.height;
            // Fill buffer
            context.drawImage(e.target, 0, 0, buffCnvs.width, buffCnvs.height);

            let filter = new ct.Filter.FilterPipeline();
            //filter.addFilter(ct.Filter.InvertFilter);
            //filter.addFilter(ct.Filter.GrayscaleFilter);
            filter.applyToCanvas(buffCnvs).then((bcnvs) => {
                // Copy buffer to the canvas on screen
                imageCnvs.width = bcnvs.width;
                imageCnvs.height = bcnvs.height;
                let imgContext = imageCnvs.getContext("2d");
                imgContext.drawImage(bcnvs, 0, 0, bcnvs.width, bcnvs.height);
            });
        });
        image.src = imagePath;


        window.areaSelector = selector;
        window.regionsManager = rm;
    });
</script>

</html>