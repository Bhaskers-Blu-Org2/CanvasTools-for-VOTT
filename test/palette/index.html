<!doctype html>
<html>

<head>
    <link rel="stylesheet" href="css/index.css" />
    <title>CanvasTools Demo</title>
</head>

<body>
    <div id="canvasToolsDiv">
        <div id="toolbarDiv">
        </div>
        <div id="selectionDiv">
            <div id="editorDiv"></div>
        </div>
    </div>

    <div id="controls">
        <div>
            <label for="imageSelect" >Choose image: </label>
            <select id="imageSelect">
            </select>
        </div>
        <div>
            <label for="filterSelect" >Add filter: </label>
            <select id="filterSelect">
            </select>
            <br />
            <label for="filterPipeline">Filter pipeline: </label><br />
            <textarea id="filterPipeline" disabled></textarea>
        </div>
    </div>
</body>
<script src="./js/ct.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", (e) => {
        let ct = CanvasTools;
        let sz = document.getElementById("editorDiv");
        let tz = document.getElementById("toolbarDiv");

        let editor = new ct.Editor(sz).api;
        editor.addToolbar(tz, ct.Editor.FullToolbarSet, "./images/icons/");

        let incrementalRegionID = 100;

        editor.onSelectionEnd = (regionData) => {
            let id = (incrementalRegionID++).toString();
            let tags = generateTagDescriptor();            
            editor.addRegion(id, regionData, tags);
        };        

        let primaryTags = [
            new ct.Core.Tag("Awesome", 0),
            new ct.Core.Tag("Amazing", "#e53"),
            new ct.Core.Tag("Brilliante", 60),
        ];

        let secondaryTags = [
            new ct.Core.Tag("Yes", 100),
            new ct.Core.Tag("No", 130),
            new ct.Core.Tag("Unknown", 160),
        ];

        let ternaryTags = [
            new ct.Core.Tag("one", 200),
            new ct.Core.Tag("two", 230),
            new ct.Core.Tag("many", 260),
        ]

        function generateTagDescriptor() {
            let rnd = Math.random();
            let rnd3 = () => {
                return Math.round(Math.random() * 2);
            };

            let tags;
            
            if (rnd < 0.2) {
                tags = new ct.Core.TagsDescriptor(null, [secondaryTags[rnd3()], ternaryTags[rnd3()]]);
            } else if (rnd < 0.4) {
                tags = new ct.Core.TagsDescriptor(primaryTags[rnd3()], [secondaryTags[rnd3()], ternaryTags[rnd3()]]);
            } else if (rnd < 0.6) {
                tags = new ct.Core.TagsDescriptor(primaryTags[rnd3()]);
            } else if (rnd < 0.8) {
                tags = new ct.Core.TagsDescriptor([primaryTags[rnd3()]]);
            } else {
                tags = new ct.Core.TagsDescriptor(); // null
            }

           
            return tags;
        };
        
        editor.onRegionMoveBegin = (id, regionData) => {
            console.log(`Move Begin ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };

        editor.onRegionMove = (id, regionData) => {
            console.log(`Moving ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };

        editor.onRegionMoveEnd = (id, regionData) => {
            console.log(`Move End ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };

        // Init image selector
        let images = [
            {
                path: "./../images/background-cat-hd.jpg",
                title: "Cat (HD)"
            },
            {
                path: "./../images/background-cat2.jpg",
                title: "Cat - Grumpy"
            },
            {
                path: "./../images/background-cat3.jpg",
                title: "Cat - Inspiring"
            },                                   
            {
                path: "./../images/background-city.jpg",
                title: "City"
            },
            {
                path: "./../images/background-forest-hd.jpg",
                title: "Forest (HD)"
            },
            {
                path: "./../images/background-glass.jpg",
                title: "Cafe"
            },
            {
                path: "./../images/background-sea-hd.jpg",
                title: "Sea (HD)"
            },
            {
                path: "./../images/background-snow.jpg",
                title: "Snow"
            }, 
        ];

        function loadImage(path) {
            let image = new Image();
            image.addEventListener("load", (e) => {
                editor.addContentSource(e.target);
            });
            image.src = path;
        }

        let imageIndex = 0;
        initImageSelect(images, (index, path) => {
            imageIndex = index;
            loadImage(path);
        });
        loadImage(images[imageIndex].path);

        // Init filter selector
        let filters = [
            {
                title: "= Clear filters = ",
                filter: null,
            },
            {
                title: "Blur Difference 4",
                filter: ct.Filters.BlurDiffFilter(4),
            },
            {
                title: "Blur Difference 8",
                filter: ct.Filters.BlurDiffFilter(8),
            },
            {
                title: "Brightness -100",
                filter: ct.Filters.BrightnessFilter(-100),
            },
            {
                title: "Brightness 100",
                filter: ct.Filters.BrightnessFilter(100),
            },
            {
                title: "Contrast 100",
                filter: ct.Filters.ContrastFilter(100),
            },
            {
                title: "Contrast 200",
                filter: ct.Filters.ContrastFilter(200),
            },            
            {
                title: "Grayscale",
                filter: ct.Filters.GrayscaleFilter,
            },
            {
                title: "Invert",
                filter: ct.Filters.InvertFilter,
            },
            {
                title: "Saturation 50%",
                filter: ct.Filters.SaturationFilter(128),
            },     
        ];
        
        let filterPipeline = document.getElementById("filterPipeline");
        initFilterSelect(filters, (index, filter) => {            
            if (filter === null) {
                filterPipeline.value = "";
                editor.clearFilters();
            } else {
                //editor.FilterPipeline.clearPipeline();
                filterPipeline.value += filters[index].title + "\n";
                editor.addFilter(filter);
            }

            loadImage(images[imageIndex].path);
        });
    });

    function initImageSelect(images, onSelect) {
        var imageSelect = document.getElementById("imageSelect");

        images.forEach((image) => {
            let o = document.createElement("option");
            o.text = image.title;
            imageSelect.add(o);
        })
        imageSelect.selectedIndex = 0;

        imageSelect.addEventListener("change", (e) => {
            let index = imageSelect.selectedIndex;
            if (index >= 0 && index < images.length) {
                onSelect(index, images[index].path);
            }
        });
    }

    function initFilterSelect(filters, onSelect) {
        var filterSelect = document.getElementById("filterSelect");

        filters.forEach((filter) => {
            let o = document.createElement("option");
            o.text = filter.title;
            filterSelect.add(o);
        });
        filterSelect.selectedIndex = 0;

        filterSelect.addEventListener("change", (e) => {
            let index = filterSelect.selectedIndex;
            if (index >= 0 && index < filters.length) {
                onSelect(index, filters[index].filter);
            }
        });
    }

    function lab2rgb(lab){
  var y = (lab[0] + 16) / 116,
      x = lab[1] / 500 + y,
      z = y - lab[2] / 200,
      r, g, b;

  x = 0.95047 * ((x * x * x > 0.008856) ? x * x * x : (x - 16/116) / 7.787);
  y = 1.00000 * ((y * y * y > 0.008856) ? y * y * y : (y - 16/116) / 7.787);
  z = 1.08883 * ((z * z * z > 0.008856) ? z * z * z : (z - 16/116) / 7.787);

  r = x *  3.2406 + y * -1.5372 + z * -0.4986;
  g = x * -0.9689 + y *  1.8758 + z *  0.0415;
  b = x *  0.0557 + y * -0.2040 + z *  1.0570;

  r = (r > 0.0031308) ? (1.055 * Math.pow(r, 1/2.4) - 0.055) : 12.92 * r;
  g = (g > 0.0031308) ? (1.055 * Math.pow(g, 1/2.4) - 0.055) : 12.92 * g;
  b = (b > 0.0031308) ? (1.055 * Math.pow(b, 1/2.4) - 0.055) : 12.92 * b;

  return [Math.max(0, Math.min(1, r)) * 255, 
          Math.max(0, Math.min(1, g)) * 255, 
          Math.max(0, Math.min(1, b)) * 255]
}


function rgb2lab(rgb){
  var r = rgb[0] / 255,
      g = rgb[1] / 255,
      b = rgb[2] / 255,
      x, y, z;

  r = (r > 0.04045) ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
  g = (g > 0.04045) ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
  b = (b > 0.04045) ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;

  x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
  y = (r * 0.2126 + g * 0.7152 + b * 0.0722) / 1.00000;
  z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;

  x = (x > 0.008856) ? Math.pow(x, 1/3) : (7.787 * x) + 16/116;
  y = (y > 0.008856) ? Math.pow(y, 1/3) : (7.787 * y) + 16/116;
  z = (z > 0.008856) ? Math.pow(z, 1/3) : (7.787 * z) + 16/116;

  return [(116 * y) - 16, 500 * (x - y), 200 * (y - z)]
}
</script>

</html>