<!doctype html>
<html>

<head>
    <link rel="stylesheet" href="css/index.css" />
    <title>CanvasTools - Palette Tests</title>
</head>

<body>
    <div id="canvasToolsDiv">
        <div id="toolbarDiv">
        </div>
        <div id="selectionDiv">
            <div id="editorDiv"></div>
        </div>
    </div>

    <div id="controls">
        <div>
            <label for="imageSelect" >Choose image: </label>
            <select id="imageSelect">
            </select>
        </div>
    </div>
</body>
<script src="./js/ct.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", (e) => {
        let ct = CanvasTools;
        let sz = document.getElementById("editorDiv");
        let tz = document.getElementById("toolbarDiv");

        let editor = new ct.Editor(sz).api;
        editor.addToolbar(tz, ct.Editor.FullToolbarSet, "./images/icons/");

        let incrementalRegionID = 100;

        editor.onSelectionEnd = (regionData) => {
            let id = (incrementalRegionID++).toString();
            let tags = generateTagDescriptor();            
            editor.addRegion(id, regionData, tags);
        };        

        let primaryTags = [
            new ct.Core.Tag("Awesome", 0),
            new ct.Core.Tag("Amazing", "#e53"),
            new ct.Core.Tag("Brilliante", 60),
        ];

        let secondaryTags = [
            new ct.Core.Tag("Yes", 100),
            new ct.Core.Tag("No", 130),
            new ct.Core.Tag("Unknown", 160),
        ];

        let ternaryTags = [
            new ct.Core.Tag("one", 200),
            new ct.Core.Tag("two", 230),
            new ct.Core.Tag("many", 260),
        ]

        function generateTagDescriptor() {
            let rnd = Math.random();
            let rnd3 = () => {
                return Math.round(Math.random() * 2);
            };

            let tags;
            
            if (rnd < 0.2) {
                tags = new ct.Core.TagsDescriptor(null, [secondaryTags[rnd3()], ternaryTags[rnd3()]]);
            } else if (rnd < 0.4) {
                tags = new ct.Core.TagsDescriptor(primaryTags[rnd3()], [secondaryTags[rnd3()], ternaryTags[rnd3()]]);
            } else if (rnd < 0.6) {
                tags = new ct.Core.TagsDescriptor(primaryTags[rnd3()]);
            } else if (rnd < 0.8) {
                tags = new ct.Core.TagsDescriptor([primaryTags[rnd3()]]);
            } else {
                tags = new ct.Core.TagsDescriptor(); // null
            }

           
            return tags;
        };
        
        editor.onRegionMoveBegin = (id, regionData) => {
            console.log(`Move Begin ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };

        editor.onRegionMove = (id, regionData) => {
            console.log(`Moving ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };

        editor.onRegionMoveEnd = (id, regionData) => {
            console.log(`Move End ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };

        // Init image selector
        let images = [
            {
                path: "./images/background-cat-hd.jpg",
                title: "Cat (HD)"
            },
            {
                path: "./images/background-cat2.jpg",
                title: "Cat - Grumpy"
            },
            {
                path: "./images/background-cat3.jpg",
                title: "Cat - Inspiring"
            },                                   
            {
                path: "./images/background-city.jpg",
                title: "City"
            },
            {
                path: "./images/background-forest-hd.jpg",
                title: "Forest (HD)"
            },
            {
                path: "./images/background-glass.jpg",
                title: "Cafe"
            },
            {
                path: "./images/background-sea-hd.jpg",
                title: "Sea (HD)"
            },
            {
                path: "./images/background-snow.jpg",
                title: "Snow"
            }, 
        ];

        function loadImage(path) {
            let image = new Image();
            image.addEventListener("load", (e) => {
                editor.addContentSource(e.target);
            });
            image.src = path;
        }

        let imageIndex = 0;
        initImageSelect(images, (index, path) => {
            imageIndex = index;
            loadImage(path);
        });
        loadImage(images[imageIndex].path);
        
    });

    function initImageSelect(images, onSelect) {
        var imageSelect = document.getElementById("imageSelect");

        images.forEach((image) => {
            let o = document.createElement("option");
            o.text = image.title;
            imageSelect.add(o);
        })
        imageSelect.selectedIndex = 0;

        imageSelect.addEventListener("change", (e) => {
            let index = imageSelect.selectedIndex;
            if (index >= 0 && index < images.length) {
                onSelect(index, images[index].path);
            }
        });
    }

</script>

</html>