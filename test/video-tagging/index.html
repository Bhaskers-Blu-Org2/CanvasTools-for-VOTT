<!doctype html>
<html>

<head>
    <link rel="stylesheet" href="css/index.css" />
    <title>CanvasTools Demo</title>
</head>

<body>
    <div id="canvasToolsDiv">
        <div id="toolbarDiv">
        </div>
        <div id="selectionDiv">
            <div id="editorDiv"></div>
        </div>
        <div id="timelineDiv"></div>
    </div>

    <div id="controls">
        <div>
            <label for="filterSelect" >Add filter: </label>
            <select id="filterSelect">
            </select>
            <br />
            <label for="filterPipeline">Filter pipeline: </label><br />
            <textarea id="filterPipeline" disabled></textarea>
        </div>
    </div>
</body>
<script src="./js/ct.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", (e) => {
        let ct = CanvasTools;
        let sz = document.getElementById("editorDiv");
        let tbz = document.getElementById("toolbarDiv");
        
        let editor = new ct.Editor(sz).api;
        editor.addToolbar(tbz, ct.Editor.FullToolbarSet, "./images/icons/");

        let incrementalRegionID = 100;

        editor.onSelectionEnd = (regionData) => {
            let id = (incrementalRegionID++).toString();
            let tags = generateTagDescriptor();            
            editor.addRegion(id, regionData, tags);
        };        

        let primaryTags = [
            new ct.Core.Tag("Awesome", 0),
            new ct.Core.Tag("Amazing", "#e53"),
            new ct.Core.Tag("Brilliante", 60),
        ];

        let secondaryTags = [
            new ct.Core.Tag("Yes", 100),
            new ct.Core.Tag("No", 130),
            new ct.Core.Tag("Unknown", 160),
        ];

        let ternaryTags = [
            new ct.Core.Tag("one", 200),
            new ct.Core.Tag("two", 230),
            new ct.Core.Tag("many", 260),
        ]

        function generateTagDescriptor() {
            let rnd = Math.random();
            let rnd3 = () => {
                return Math.round(Math.random() * 2);
            };

            let tags;
            
            if (rnd < 0.2) {
                tags = new ct.Core.TagsDescriptor(null, [secondaryTags[rnd3()], ternaryTags[rnd3()]]);
            } else if (rnd < 0.4) {
                tags = new ct.Core.TagsDescriptor(primaryTags[rnd3()], [secondaryTags[rnd3()], ternaryTags[rnd3()]]);
            } else if (rnd < 0.6) {
                tags = new ct.Core.TagsDescriptor(primaryTags[rnd3()]);
            } else if (rnd < 0.8) {
                tags = new ct.Core.TagsDescriptor([primaryTags[rnd3()]]);
            } else {
                tags = new ct.Core.TagsDescriptor(); // null
            }

           
            return tags;
        };
        
        editor.onRegionMove = (id, regionData) => {
            //console.log(`Moved ${id}: {${x}, ${y}} x {${width}, ${height}}`);
        };

        // Init video
        let videoPath = "./../video/sintel_trailer-720p.mp4";

        function loadVideo(path) {
            let video = document.createElement('video');
            video.autoplay = false;
            video.addEventListener("loadeddata", (e) => {
                editor.addContentSource(e.target);
            });

            video.addEventListener("canplay", (e) => {
                editor.addContentSource(e.target);
            });

            video.addEventListener("loadedmetadata", (e) => {
                initTimeline(e.target);
            })
            video.src = path;

            return video;
        }

        let video = loadVideo(videoPath);

        // Init filter selector
        let filters = [
            {
                title: "= Clear filters = ",
                filter: null,
            },
            {
                title: "Blur Difference 4",
                filter: ct.Filters.BlurDiffFilter(4),
            },
            {
                title: "Blur Difference 8",
                filter: ct.Filters.BlurDiffFilter(8),
            },
            {
                title: "Brightness -100",
                filter: ct.Filters.BrightnessFilter(-100),
            },
            {
                title: "Brightness 100",
                filter: ct.Filters.BrightnessFilter(100),
            },
            {
                title: "Contrast 100",
                filter: ct.Filters.ContrastFilter(100),
            },
            {
                title: "Contrast 200",
                filter: ct.Filters.ContrastFilter(200),
            },            
            {
                title: "Grayscale",
                filter: ct.Filters.GrayscaleFilter,
            },
            {
                title: "Invert",
                filter: ct.Filters.InvertFilter,
            },
            {
                title: "Saturation 50%",
                filter: ct.Filters.SaturationFilter(128),
            },     
        ];
        
        let filterPipeline = document.getElementById("filterPipeline");
        initFilterSelect(filters, (index, filter) => {            
            if (filter === null) {
                filterPipeline.value = "";
                editor.clearFilters();
            } else {
                //editor.FilterPipeline.clearPipeline();
                filterPipeline.value += filters[index].title + "\n";
                editor.addFilter(filter);
            }

            editor.addContentSource(video);
        });
    });

    function initTimeline(video) {
        let tlz = document.getElementById("timelineDiv");

        // Timeline init
        let timelineManager = new CanvasTools.TimelineManager(tlz, true);
        let timeline = new CanvasTools.Core.TimelineData(0, video.duration, 24);
        timeline.addChangeListener((data) => {
            console.log(`T1: [${data.begin}, ${data.end}] -> ${data.current}s, ${data.frame}fr`);
            video.currentTime = data.current;
        });

        timeline.current = 0;        
        timelineManager.addTimelineRange(timeline);

        /* let timeline2 = new CanvasTools.Core.TimelineData(10, 20, 30, 0);
        timeline2.addChangeListener((data) => {
            console.log(`T2 [${data.begin}, ${data.end}] -> ${data.current}s, ${data.frame}fr`);
        });

        timeline2.current = 15;        
        timelineManager.addTimeline(timeline2); */
    }

    function initFilterSelect(filters, onSelect) {
        var filterSelect = document.getElementById("filterSelect");

        filters.forEach((filter) => {
            let o = document.createElement("option");
            o.text = filter.title;
            filterSelect.add(o);
        });
        filterSelect.selectedIndex = 0;

        filterSelect.addEventListener("change", (e) => {
            let index = filterSelect.selectedIndex;
            if (index >= 0 && index < filters.length) {
                onSelect(index, filters[index].filter);
            }
        });
    }
</script>

</html>